version: 2.1

jobs:
  run-test:
    docker:
      - image: cimg/node:18.18.1
    steps:
      - checkout
      - run:
          name: Run unit test
          command: |
            # Your code here
            cd app
            npm install
            npm run test

  build-docker-image:
    docker:
      - image: cimg/base:2022.06
    steps:
      - checkout
      - run:
          name: Application build
          command: |
            docker build -t hongduc2994/udacity-capstone:latest .
            docker push hongduc2994/udacity-capstone:latest
  
  create_nodegroup:
    docker:
      - image: cimg/base:2022.06
    steps:
      - checkout
      - run:
          name: Install eksctl
          command: |
            curl -sLO "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz"
            curl -sL "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_checksums.txt" | grep $PLATFORM | sha256sum --check
            tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp && rm eksctl_$PLATFORM.tar.gz
            sudo mv /tmp/eksctl /usr/local/bin
      - run:
          name: Create nodegroup
          command: |
            aws eks update-kubeconfig --name capstone-cluster
            eksctl create nodegroup --config-file=./kube_config/node_group.yaml

  deploy_application:
    machine:
      image: ubuntu-2204:2022.04.2
    steps:
      - checkout
      - run:
          name: Deploy application
          command: |
            aws eks update-kubeconfig --name capstone-cluster
            kubectl apply -f ./kube_config/deployment.yaml
            kubectl apply -f ./kube_config/service.yaml

workflows:
  default:
    jobs:
      - run-test
      - build-docker-image:
          requires: [run-test]
      - create_nodegroup:
          requires: [build-docker-image]